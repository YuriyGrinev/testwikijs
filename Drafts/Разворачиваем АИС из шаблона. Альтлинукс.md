# 1. Делаем клон машины из шаблона

![clone_ais_from_template.png](clone_ais_from_template.png)
Настройки клонирования
![clone_ais_VM_config_.png](clone_ais_VM_config_.png)
После создания клона запускаем машину.

# 2. Подготавливаем машину

### 2.0 меняем ip адрес и роут

`vim /etc/net/ifaces/eth0/ipv4address vim /etc/net/ifaces/eth0/ipv4route ifdown eth0 && ifup eth0`

### 2.1 Меняем имя машины

`vim /etc/hostname`

### 2.2 пароль root'а и admin

`passwd root passwd admin`

### 2.3 Установим переменные

`export EDITOR=vim`

`export MFCid=27`

`export MFCip=192.168.254.126`

### 2.3 Переименовываем каталоги и удаляем лишний

`mv /www/ais24/ /www/ais$MFCid/ mv /www/ais$MFCid/ais24/ /www/ais$MFCid/ais$MFCid/ rm -rf /www/zamena/`

### 2.4 Правим файл hosts

`sed -e 's/ais24/ais'"$MFCid"'/g' -e 's/db24/db'"$MFCid"'/g' -e 's/fs24/fs'"$MFCid"'/g' -e 's/edo24/edo'"$MFCid"'/g' -e 's/mfc24/mfc'"$MFCid"'/g' -i /etc/hosts sed -e 's/168.192/168.211/g' -i /etc/hosts vim /etc/hosts`

### 2.5 Фиксируем изменения

`integalert fix`

# 3. Редактируем конфиги

### 3.0 Конфиги Apache

Переименовываем конфиг

`mv /etc/httpd2/conf/sites-enabled/ais24.conf /etc/httpd2/conf/sites-enabled/ais$MFCid.conf`

Редактируем его

`sed -e 's/ais24/ais'"$MFCid"'/g' -e 's/mfc24/mfc'"$MFCid"'/' -i /etc/httpd2/conf/sites-enabled/ais$MFCid.conf`

Конфиг mfc-core

`sed -e 's/ais24/ais'"$MFCid"'/g' -e 's/mfc24/mfc'"$MFCid"'/' -i /etc/httpd2/conf/sites-enabled/mfc-core.conf`

Правим DocumentRoot

`sed -e 's/ais24/ais'"$MFCid"'/g' -i /etc/httpd2/conf/sites-enabled/000-default.conf`

Проверяем конфигурацию Apache

`apachectl -t`

### 3.1 Конфиги АИС

`vim /www/ais$MFCid/ais$MFCid/server.ini vim /www/ais$MFCid/ais$MFCid/config/db.php`

выставляем права

`chown -R apache:apache /www/ais$MFCid/ais$MFCid/* chmod 777 /home/www/ais$MFCid/ais$MFCid/tmp`

### 3.2 Сервера электронной очереди

`vim /www/ais$MFCid/elque/config.js`

Добавляем в секцию **module.exports.env_conf**

`timeUserGone : 60, // Время отсутствия соединения с пользователем за которое считаем его ушедшим из программы timePriemAll : 2, timeHeaderWait : 3`

### 3.3 mfc-core конфиг и службу

`vim /www/ais$MFCid/mfc-core/.env sed -e 's/ais24/ais'"$MFCid"'/g' -i /etc/systemd/system/elque.service systemctl daemon-reload systemctl restart elque.service`

### 3.4 Crontab

`crontab -e`

### 3.5 **Обработчика очереди**

`sed -e 's/ais24/ais'"$MFCid"'/g' -i /etc/supervisord.d/queue-laravel.ini`

### 3.6 Правим скрипты автообновлений

`sed -e 's/ais24/ais'"$MFCid"'/g' -e 's/mfc24/mfc'"$MFCid"'/' -i /www/ais$MFCid/elque/update-elque.sh sed -e 's/ais24/ais'"$MFCid"'/g' -e 's/mfc24/mfc'"$MFCid"'/' -i /www/ais$MFCid/mfc-core/update-core.sh`

Добавляем в файл `/www/ais$MFCid/mfc-core/update-core.sh`

`vim /www/ais$MFCid/mfc-core/update-core.sh`

`chmod 777 -R /home/www/aisXX/mfc-core/ chown -R apache:apache /home/www/aisXX/mfc-core/`

### 3.7 Добавляем ДНС

`vim /etc/resolv.conf`

`nameserver 192.168.254.1 nameserver 78.88.8.8`

`update_chrooted -f all`

# 4. Обновляем АИС

Удаляем 170 хост

`vim /root/.ssh/known_hosts`

Скачиваем файл

`cd /www/ais$MFCid/ais$MFCid/ scp admin@192.168.254.170:/home/admin/Archive_2.2023.04.26.1618.zip . unzip Archive_2.2023.04.26.1618.zip rm Archive*`

выставляем права

`chown -R apache:apache /www/ais$MFCid/ais$MFCid/* chmod 777 /home/www/ais$MFCid/ais$MFCid/tmp/* chmod -R 777 /home/www/ais$MFCid/mfc-core/storage/framework/cache/*`

# 5. Копируем видео

Переходим в каталог с плейлистом

`cd /www/ais$MFCid/ais$MFCid/templates/queue/4.0/`

Копируем в него плейлист со старой машины. Не забываем поменять IP-адрес машины.

`scp root@$MFCip:/var/www/ais$MFCid/ais$MFCid/templates/queue/4.0/playlist.xml .`

Переходим в каталог с видео на новой машине

`cd /www/ais$MFCid/ais$MFCid/videos/`

Удаляем все файлы в каталоге

`yes | rm *`

Создаем файл со скриптом

`vim getvideo.py`

Копируем в него следующий код

```Python
import os
import subprocess
import xml.etree.ElementTree as ET

def get_files (playlist, mfcid):
    #Парсим XML-файл
    tree = ET.parse(playlist)
    root = tree.getroot()

    # Получаем все элементы 'location' с помощью XPath
    locations = root.findall(".//{http://xspf.org/ns/0/}location")
    str = f'http://ais{mfcid}.mfc{mfcid}.umfc26//videos/'
    locations_list = [location.text.replace(str, "") for location in locations]

    # Выводим список значений
    return locations_list

def download(hostname, remote_files):
    for file_url in remote_files:
        subprocess.call(['curl', '-O', f'http://{hostname}/videos/{file_url}'])

mfcid = os.environ['MFCid']
hostname = os.environ['MFCip']
playlist = f'/www/ais{mfcid}/ais{mfcid}/templates/queue/4.0/playlist.xml'
remote_files = get_files(playlist, mfcid)
download(hostname, remote_files)
```

Запускаем

`python3 getvideo.py`

Удаляем файл

`rm getvideo.py*`

# 6. Обновляем ОС

`apt-get update apt-get dist-upgrade integalert fix`

# 7. Синхронизация времени

`vim /etc/ntpd.conf`

`servers ntp3.ntp-servers.net`

`ntpd -d ntp3.ntp-servers.net`

`systemctl start ntpd.service`

`systemctl enable ntpd.service`

`date +%T -s "09:41:30"`