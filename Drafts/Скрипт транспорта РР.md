Для того, чтобы скрипт исполнялся

`chmod +x transportftp.py`

Для автоматической работы скрипта создать новую службу в системе vim /etc/systemd/system/rr.service

```
[Unit]
Description=RR transport FTP Python script
After=httpd.service

[Service]
Type=simple
AmbientCapabilities=CAP_SYS_RAWIO
User=root
ExecStart=/usr/bin/python /var/www/ais09/rr09/transportftp.py
Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
```

Листинг скрипта:

```python
#!/usr/bin/env python

import ftplib
import os
import logging
import datetime
from time import ctime
from time import sleep
import shutil
try:
    import httplib
except: import http.client as httplib
try:
    from lxml import etree
except ImportError:
    import xml.etree.ElementTree as etree

parser = etree

server = "192.168.254.41" #исправить сервер FTP
username = "153" #код РР
password = "153" #код РР
ftp_dowload = "in"
ftp_upload = "out"
# исправить пути до каталогов
dowload = "/var/www/ais09/ais09/rosreestr/in" 
upload = "/var/www/ais09/ais09/rosreestr/out"
rr_archive = "/var/www/ais09/rr09/archive"
# исправить адрес сервера АИС
ip_ais = "ais09.mfc09.umfc26"
reload_min = 25


def sendingRR(ip_ais):
    conn = httplib.HTTPConnection(ip_ais)
    conn.request("GET", "/rosreestrGetStatus.php")
    r = conn.getresponse()
    return r

def ftp_uploads(file, path):
    host_file = os.path.join(path, file)
    while True:
        try:
            with open(host_file, 'rb') as fobj:
                ftp.storbinary('STOR ' + file, fobj, 1024)
                size_disk=os.path.getsize(host_file)
                size_ftp=ftp.size(file)
                print(size_disk,size_ftp)
                if size_disk==size_ftp:
                    logging.info("Uploading file : %s" % file)
                    print('File uploaded!')
                    break
        except:
            logging.error("File upload error : %s   duplicate file" % file)
            print('File upload error!')
            sleep(4)

def getFromXMl (rr_out,xml,rr_archive_out):
    try:
        tree = parser.parse(os.path.join(rr_out, xml))
        root = tree.getroot()
        zipFile = root.find('Info').find('Attach').find('Name').text
        logging.info("Check XML : %s" % xml)
        if zipFile:
            print(xml)
            print(zipFile)
            logging.info("Upload ZIP to FTP : %s" % zipFile)
            host_file = os.path.join(rr_out, zipFile)
            if os.path.isfile(host_file):
                ftp_uploads(zipFile, rr_out)
                logging.info("Relocated ZIP to archive : %s" % zipFile)
                shutil.move(host_file, rr_archive_out)
                logging.info("Upload XML to FTP : %s" % xml)
                ftp_uploads(xml, rr_out)
                host_file = os.path.join(rr_out, xml)
                logging.info("Relocated to archive : %s" % xml)
                shutil.move(host_file, rr_archive_out)
                print('___________________________________________________')
            else:
                logging.info("ZIP-fle not found : %s" % zipFile)
                print(zipFile)
        else:
            print('___________________________________________________')

    except:
        print(xml)
        logging.info("Upload XML to FTP : %s" % xml)
        ftp_uploads(xml,rr_out)
        host_file = os.path.join(rr_out, xml)
        logging.info("Relocated file in archive : %s" % xml)
        shutil.move(host_file, rr_archive_out)

def ftp_download(filename,rr_in,rr_archive):
    logging.info("Upload file : %s" %filename)
    host_file = os.path.join(rr_in, filename)
    print(filename)
    while True:
        try:
            with open(host_file, 'wb') as local_file:
                ftp.retrbinary('RETR ' + filename, local_file.write)

            size_disk = os.path.getsize(host_file)
            size_ftp = ftp.size(filename)
            print(size_disk, size_ftp)
            if size_disk == size_ftp:
                logging.info("File download : %s" % filename)
                print('File download')
                logging.info("deleting file from FTP : %s" % filename)
                ftp.delete(filename)
                rr_archive = rr_archive + filename
                logging.info("Coping file to archive : %s" % filename)
                shutil.copy2(host_file, rr_archive)
                break
        except:
            print('Download error: duplicated download')
            logging.error("Download error : %s" % filename)
            os.remove(host_file)
    return 0

if (os.path.isdir('log'))==False:
    os.mkdir('log')

while True:
    now = datetime.datetime.now()
    date=now.strftime("%d-%m-%Y")
    try:
        log='log/log_'+date+'.log'
        logging.basicConfig(filename=log, level=logging.INFO)
        logging.info("Start programm %s " %(now.strftime("%H:%M:%S")))
        logging.info("reading conf file " )
        date_log=os.path.getctime(log)
        print (ctime(date_log))
    except:
        pass

    """
    Create, check archive dir
    
    """
    if (os.path.isdir(rr_archive + '/' + date)):
        rr_archive_in = rr_archive + '/' + date + '/' + 'in/'
        rr_archive_out = rr_archive + '/' + date + '/' + 'out/'
    else:
        logging.info("Create archive dir")
        os.mkdir(os.path.join(rr_archive + '/' + date))
        os.mkdir(rr_archive + '/' + date + '/' + 'in')
        os.mkdir(rr_archive + '/' + date + '/' + 'out')
        rr_archive_in = rr_archive + '/' + date + '/' + 'in/'
        rr_archive_out = rr_archive + '/' + date + '/' + 'out/'


    logging.info("Connct to FTP %s" %server)
    print("Connect to FTP "+server )
    try:
        ftp = ftplib.FTP(server)
        ftp.login(username, password)
        logging.info("Download files from FTP")

        """
        Download files from FTP
        """
        ftp.cwd(ftp_dowload)
        while True:
            try:
                filenames = ftp.nlst()
                #print (filenames)
                if filenames==[]:
                    break
                z=1
                logging.info(" Reading FTP dir : %s " % ftp_dowload)
                for filename in filenames:
                    z = ftp_download(filename, dowload, rr_archive_in)
                if z == 0:
                    break
            except:
                logging.error("Reading FTP dir error %s replay after 5 sec" % ftp_upload)
                sleep(5)

        logging.info("Upload data to AIS MFC from %s" % ip_ais)
        try:
            r = sendingRR(ip_ais)
            logging.info("response received %s %s" % r.status, r.reason)
        except:
            logging.error("Other error connection to AIS : %s " %  ip_ais)
        
        """
        Upload data to FTP
        """

        logging.info("Uploading data to FTP")
        ftp.cwd('/.//'+ftp_upload)
        logging.info("Response list XML-files in dir %s" % upload)
        files = os.listdir(upload)
        xmls = filter(lambda x: x.endswith('.xml'), files)
        i = 1
        for xml in xmls:
            print(i)
            getFromXMl(upload, xml, rr_archive_out)
            i += 1

        logging.info("Files uploaded : %s" % (i - 1))
        print(i)
        ftp.quit()
        logging.info("Disconnect FTP  %s" % server)
        print(now.strftime("%H:%M"))
        logging.info("STOP %s " % (now.strftime("%H:%M:%S")))
        logging.info("____________________________________________________________________________________________________________")
        sleep(reload_min * 60)      
    except:
        ftp.quit()
        logging.error("Connect to FTP ERROR, replay connect after 4 sec")
        print("Retry after 4 seconds")
        sleep(4)

```